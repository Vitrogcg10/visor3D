
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Visor 3D â€“ Proyecto</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<style>
:root{
  --bg:#111; --panel:#1b1b1b; --text:#eaeaea; --muted:#9aa0a6;
  --primary:#1167b1; --primary-hover:#0e5795; --accent:#22c55e;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial,sans-serif}
header{padding:12px 16px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center;gap:12px}
h1{margin:0;font-size:18px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{border:1px solid #333;background:#191919;color:var(--text);padding:10px 14px;border-radius:8px;cursor:pointer}
.btn:hover{border-color:#444}
.btn-primary{background:var(--primary);border-color:transparent}
.btn-primary:hover{background:var(--primary-hover)}
.btn[disabled]{opacity:.6;pointer-events:none}
.layout{display:grid;grid-template-columns:1fr 320px;height:calc(100vh - 56px)}
#app{position:relative;background:#0f0f0f}
#canvasWrap{position:absolute;inset:0}
aside{background:var(--panel);border-left:1px solid #222;padding:12px;overflow:auto}
.kv{display:grid;grid-template-columns:130px 1fr;gap:6px;font-size:13px}
.kv .label{color:var(--muted)}
.progress{margin-top:8px;height:8px;background:#222;border-radius:999px;overflow:hidden}
.progress .bar{height:100%;width:0%;background:var(--accent);transition:width .2s ease}
.small{color:var(--muted);font-size:12px}
.footer{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.35);padding:6px 8px;border-radius:6px;font-size:12px}

/* MenÃº del botÃ³n Chat */
.menu{position:relative;display:inline-block}
.menu-panel{position:absolute;top:110%;left:0;background:#1f1f1f;border:1px solid #333;border-radius:8px;padding:6px;display:none;min-width:220px;z-index:1000}
.menu-item{padding:8px 10px;cursor:pointer;border-radius:6px}
.menu-item:hover{background:#262626}
</style>

<!-- three.js (mÃ³dulos) -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/"
  }
}
</script>
</head>
<body>
<header>
  <h1 id="headerTitle">Visor 3D â€“ Proyecto</h1>

  <div class="toolbar">
    <button id="btnOpenDoc" class="btn">ðŸ“„ DocumentaciÃ³n</button>

    <label for="fileGlb" class="btn" style="cursor:pointer;">ðŸ“¦ Cargar modelo (.glb)</label>
    <input id="fileGlb" type="file" accept=".glb,.gltf" style="display:none" />

    <button id="btnRecenter" class="btn">ðŸŽ¯ Recentrar</button>
    <button id="btnSolicitar" class="btn btn-primary">ðŸ”§ Solicitar refacciÃ³n</button>

    <div class="menu">
      <button id="btnChat" class="btn">ðŸ’¬ Chat Teams â–¾</button>
      <div id="chatMenu" class="menu-panel">
        <div id="chatClient" class="menu-item">Abrir en Teams (cliente)</div>
        <div id="chatWeb" class="menu-item">Abrir en Teams (web)</div>
      </div>
    </div>
  </div>
</header>

<div class="layout">
  <main id="app">
    <div id="canvasWrap"></div>
    <div class="footer small">Listo.</div>
  </main>

  <aside>
    <h3>InformaciÃ³n</h3>
    <div class="kv">
      <div class="label">Proyecto</div><div id="kvProyecto">â€”</div>
      <div class="label">ID</div><div id="kvFile">â€”</div>
      <div class="label">Parte</div><div id="kvParte">â€”</div>
      <div class="label">Subensamble</div><div id="kvSub">â€”</div>
    </div>

    <h3 style="margin-top:12px;">Estado</h3>
    <div id="status">Sin modelo cargado.</div>
    <div class="progress"><div id="progressBar" class="bar"></div></div>
    <div id="progressText" class="small">0% 0 / 0 KB</div>
  </aside>
</div>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
import { MeshoptDecoder } from 'three/addons/libs/meshopt_decoder.module.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

/* ---------- ParÃ¡metros de la URL ---------- */
const qs = new URLSearchParams(location.search);
const fileId   = qs.get('fileId')   || '';
const proyecto = qs.get('proyecto') || '';
const glbUrl   = qs.get('glb')      || '';
const docsUrl  = qs.get('docs')     || '';

/* ---------- Elementos UI ---------- */
const headerTitle = document.getElementById('headerTitle');
const kvProyecto  = document.getElementById('kvProyecto');
const kvFile      = document.getElementById('kvFile');
const kvParte     = document.getElementById('kvParte');
const kvSub       = document.getElementById('kvSub');
const statusEl    = document.getElementById('status');
const progressBar = document.getElementById('progressBar');
const progressText= document.getElementById('progressText');

headerTitle.textContent = `Visor 3D â€“ Proyecto ${proyecto || '(sin nombre)'}`;
kvProyecto.textContent  = proyecto || 'â€”';
kvFile.textContent      = fileId   || 'â€”';

/* ---------- Botones ---------- */
const btnOpenDoc  = document.getElementById('btnOpenDoc');
const btnRecenter = document.getElementById('btnRecenter');
const btnSolicitar= document.getElementById('btnSolicitar');
const btnChat     = document.getElementById('btnChat');
const chatMenu    = document.getElementById('chatMenu');
const chatClient  = document.getElementById('chatClient');
const chatWeb     = document.getElementById('chatWeb');
const fileGlb     = document.getElementById('fileGlb');

/* DocumentaciÃ³n */
if (docsUrl) {
  btnOpenDoc.onclick = () => window.open(docsUrl, '_blank', 'noopener,noreferrer');
} else {
  btnOpenDoc.setAttribute('disabled', 'true');
}

/* Solicitar refacciÃ³n (mailto) */
btnSolicitar.onclick = () => {
  const subject = `Solicitud de refacciÃ³n - ${proyecto || '(sin nombre)'}`;
  const body = [
    `Proyecto: ${proyecto || '-'}`,
    `ID: ${fileId || '-'}`,
    `Parte: ${kvParte.textContent || '-'}`,
    `Subensamble: ${kvSub.textContent || '-'}`,
    `DocumentaciÃ³n: ${docsUrl || '-'}`
  ].join('\n');
  window.location.href = `mailto:mantenimiento@tuempresa.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
};

/* Chat Teams â€“ configura el destinatario (UPN o BotID) */
const TEAMS_RECIPIENT = ''; // Ejemplo UPN: 'usuario@tuempresa.com'  |  Bot: '28:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'
btnChat.addEventListener('click', () => {
  chatMenu.style.display = (chatMenu.style.display === 'block') ? 'none' : 'block';
});
document.addEventListener('click', (e) => {
  if (!chatMenu.contains(e.target) && e.target !== btnChat) chatMenu.style.display = 'none';
});
chatClient.onclick = () => {
  if (!TEAMS_RECIPIENT) { alert('Configura TEAMS_RECIPIENT en el cÃ³digo.'); return; }
  // Cliente de Teams
  window.location.href = `msteams:/l/chat/0/0?users=${encodeURIComponent(TEAMS_RECIPIENT)}`;
};
chatWeb.onclick = () => {
  const params = new URLSearchParams({
    proyecto, fileId,
    parte: kvParte.textContent || '',
    subensamble: kvSub.textContent || ''
  });
  window.open(`https://teams.microsoft.com/l/chat/0/0?${params.toString()}`, '_blank', 'noopener,noreferrer');
};

/* ---------- Three.js setup ---------- */
const container = document.getElementById('canvasWrap');
const renderer  = new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(container.clientWidth, container.clientHeight);
container.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);

const camera = new THREE.PerspectiveCamera(60, container.clientWidth/container.clientHeight, 0.1, 2000);
camera.position.set(3,2,6);

const controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(0,1,0);
controls.enableDamping = true;
controls.update();

scene.add(new THREE.HemisphereLight(0xffffff,0x222222,0.5));
const dir = new THREE.DirectionalLight(0xffffff,1.0);
dir.position.set(5,10,7.5);
scene.add(dir);

/* ---------- Loader GLB ---------- */
const gltfLoader  = new GLTFLoader();
const dracoLoader = new DRACOLoader();
dracoLoader.setDecoderPath('https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/libs/draco/');
gltfLoader.setDRACOLoader(dracoLoader);
gltfLoader.setMeshoptDecoder(MeshoptDecoder);

let currentModel = null;

function loadGLB(url) {
  if (!url) { statusEl.textContent = 'Sin URL de modelo.'; return; }
  statusEl.textContent = 'Cargando modelo (.glb)â€¦';
  progressBar.style.width = '0%';
  progressText.textContent = '0% 0 / 0 KB';

  gltfLoader.load(url, (gltf) => {
    if (currentModel) scene.remove(currentModel);
    currentModel = gltf.scene;
    scene.add(currentModel);
    statusEl.textContent = 'Modelo cargado.';
    recenterView();
  }, (xhr) => {
    const pct = xhr.total ? Math.round((xhr.loaded/xhr.total)*100) : 0;
    progressBar.style.width = pct + '%';
    const kbL = (xhr.loaded/1024).toFixed(1);
    const kbT = xhr.total ? (xhr.total/1024).toFixed(1) : '0';
    progressText.textContent = `${pct}% ${kbL} / ${kbT} KB`;
  }, (err) => {
    console.error(err);
    statusEl.textContent = 'Error al cargar el GLB (revisa la URL y CORS).';
  });
}

function recenterView() {
  if (!currentModel) return;
  const box = new THREE.Box3().setFromObject(currentModel);
  const size = new THREE.Vector3();
  const center = new THREE.Vector3();
  box.getSize(size); box.getCenter(center);
  controls.target.copy(center); controls.update();
  const maxDim = Math.max(size.x, size.y, size.z);
  const fitDist = maxDim * 1.5;
  const dirVec = new THREE.Vector3(1,0.6,1).normalize();
  camera.position.copy(center).addScaledVector(dirVec, fitDist);
  camera.near = Math.max(0.01, maxDim/1000);
  camera.far  = maxDim * 1000;
  camera.updateProjectionMatrix();
}

/* ---------- AnimaciÃ³n ---------- */
function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }
animate();

/* ---------- Resize ---------- */
window.addEventListener('resize', () => {
  const w = container.clientWidth, h = container.clientHeight;
  renderer.setSize(w,h); camera.aspect = w/h; camera.updateProjectionMatrix();
});

/* ---------- Recentrar ---------- */
btnRecenter.addEventListener('click', recenterView);

/* ---------- Cargar desde archivo local (opcional) ---------- */
fileGlb.addEventListener('change', (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  const blobUrl = URL.createObjectURL(file);
  loadGLB(blobUrl);
});

/* ---------- SelecciÃ³n y resaltado ---------- */
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

function clearHighlights(root) {
  if (!root) return;
  root.traverse((obj) => {
    const toRemove = [];
    obj.children.forEach((c) => {
      if (c.name === '__highlight__') toRemove.push(c);
    });
    toRemove.forEach((c) => {
      c.geometry && c.geometry.dispose();
      c.material && c.material.dispose();
      obj.remove(c);
    });
  });
}

function highlightSelection(root) {
  if (!root) return;
  root.traverse((child) => {
    if (child.isMesh && child.geometry) {
      const edges = new THREE.EdgesGeometry(child.geometry, 8);
      const mat = new THREE.LineBasicMaterial({
        color: 0x22c55e,
        transparent: true,
        opacity: 1.0,
        depthTest: false,
        depthWrite: false,
        toneMapped: false
      });
      const lines = new THREE.LineSegments(edges, mat);
      lines.name = '__highlight__';
      lines.renderOrder = 9999;
      child.add(lines);
    }
  });
}

renderer.domElement.addEventListener('click', (event) => {
  if (!currentModel) return;
  const rect = renderer.domElement.getBoundingClientRect();
  mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);

  const hits = raycaster.intersectObjects(currentModel.children, true)
    .filter(h => h.object && h.object.name !== '__highlight__');

  if (hits.length > 0) {
    const obj = hits[0].object;
    let root = obj;
    while (root.parent && root.parent !== currentModel) root = root.parent;

    kvParte.textContent = obj.name  || '(sin nombre)';
    kvSub.textContent   = root.name || '(sin nombre)';

    clearHighlights(currentModel);
    highlightSelection(root);
  } else {
    kvParte.textContent = 'â€”';
    kvSub.textContent   = 'â€”';
    clearHighlights(currentModel);
  }
});

/* ---------- Carga inicial desde parÃ¡metro ---------- */
if (glbUrl) loadGLB(glbUrl);
</script>
</body>
</html>
``
