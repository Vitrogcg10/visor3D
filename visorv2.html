
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Visor 3D</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { margin:0; background:#111; color:#eaeaea; font-family:Arial,sans-serif; }
header {
  padding:10px 16px;
  border-bottom:1px solid #222;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
button {
  background:#1f1f1f;
  color:#fff;
  border:1px solid #333;
  border-radius:6px;
  padding:8px 12px;
  cursor:pointer;
}
button:hover { border-color:#555; }

.layout {
  display:grid;
  grid-template-columns: 1fr 300px;
  height: calc(100vh - 52px);
}
#viewer { position:relative; }
#canvas { position:absolute; inset:0; }

aside {
  border-left:1px solid #222;
  padding:12px;
  background:#161616;
}
.label { color:#9aa0a6; font-size:12px; margin-top:10px; }
</style>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/"
  }
}
</script>
</head>

<body>

<header>
  <h1 id="hdr">Visor 3D</h1>
  <button id="btnCenter">Recentrar</button>
</header>

<div class="layout">
  <div id="viewer">
    <div id="canvas"></div>
  </div>
  <aside>
    <div class="label">Proyecto</div>
    <div id="pProyecto">—</div>
    <div class="label">File ID</div>
    <div id="pFile">—</div>
    <div class="label">Parte</div>
    <div id="pParte">—</div>
    <div class="label">Subensamble</div>
    <div id="pSub">—</div>
  </aside>
</div>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

var qs = new URLSearchParams(window.location.search);
var proyecto = qs.get('proyecto');
var fileId = qs.get('fileId');
var glbUrl = qs.get('glb');

if (proyecto) document.getElementById('hdr').innerText = 'Visor 3D - ' + proyecto;
if (fileId) document.getElementById('pFile').innerText = fileId;
if (proyecto) document.getElementById('pProyecto').innerText = proyecto;

var container = document.getElementById('canvas');

var renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(container.clientWidth, container.clientHeight);
container.appendChild(renderer.domElement);

var scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);

var camera = new THREE.PerspectiveCamera(60, container.clientWidth/container.clientHeight, 0.1, 2000);
camera.position.set(3,2,6);

var controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

scene.add(new THREE.HemisphereLight(0xffffff, 0x333333, 0.7));

var light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(5,10,7);
scene.add(light);

var loader = new GLTFLoader();
var model = null;

function centerModel(){
  if (!model) return;
  var box = new THREE.Box3().setFromObject(model);
  var center = box.getCenter(new THREE.Vector3());
  controls.target.copy(center);
  controls.update();
}

if (glbUrl){
  loader.load(glbUrl, function(gltf){
    model = gltf.scene;
    scene.add(model);
    centerModel();
  });
}

var raycaster = new THREE.Raycaster();
var mouse = new THREE.Vector2();

renderer.domElement.addEventListener('click', function(e){
  if (!model) return;

  var rect = renderer.domElement.getBoundingClientRect();
  mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  var hits = raycaster.intersectObjects(model.children, true);

  if (hits.length > 0){
    var mesh = hits[0].object;
    var root = mesh;
    while (root.parent && root.parent !== model) root = root.parent;

    document.getElementById('pParte').innerText = mesh.name || '(sin nombre)';
    document.getElementById('pSub').innerText = root.name || '(sin nombre)';
  }
});

document.getElementById('btnCenter').onclick = centerModel;

function animate(){
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate

