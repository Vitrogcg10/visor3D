
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visor 3D ‚Äì Prototipo QR (v12.2.2, GitHub + ES Modules)</title>
  <style>
    :root{ --bg:#0f1f2f; --panel:#17334f; --accent:#2a6fbd; --accent2:#3281db; --text:#eaf2ff; --muted:#cfe1ff; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: Segoe UI, Roboto, Arial, sans-serif; }
    header { padding:14px 16px; border-bottom:1px solid #1f4569; background:var(--panel); }
    h1 { font-size:18px; margin:0 0 8px 0; font-weight:700; }
    .actions { display:flex; flex-wrap:wrap; gap:8px; }
    .btn { display:inline-flex; align-items:center; gap:6px; background:var(--accent); color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; font-size:13px; text-decoration:none; }
    .btn:hover{ background:var(--accent2); }
    #main { display:grid; grid-template-columns: 2fr 1fr; gap:12px; height: calc(100% - 84px); padding:12px; }
    #viewerCard { background:var(--panel); border-radius:10px; position:relative; overflow:hidden; }
    #sideCard { background:var(--panel); border-radius:10px; padding:10px 12px; overflow:auto; }
    canvas { display:block; width:100%; height:100%; }
    .section { margin-top:8px; }
    .section h3 { margin:8px 0 6px 0; font-size:14px; font-weight:700; }
    .infoGrid { display:grid; grid-template-columns: 110px 1fr; gap:6px; font-size:13px; }
    .label { color:var(--muted); }
    #status { font-size:13px; color:var(--muted); }
    #drop { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); color:#fff; font-size:18px; text-align:center; padding:12px; }
    .footer { padding:6px 16px; font-size:12px; color:var(--muted); }
    input[type=file]{ display:none; }
    #error { color:#ffb3b3; font-size:12px; margin-top:6px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <header>
    <h1>Visor 3D ‚Äì Prototipo QR (v12.2.2)</h1>
    <div class="actions">
      <a class="btn" id="btnDocs" href="#"><span>üìÑ</span> Abrir documentaci√≥n</a>
      <label class="btn" for="fileInput"><span>üì¶</span> Cargar modelo (.glb)</label>
      <input id="fileInput" type="file" accept=".glb" />
      <button class="btn" id="btnFit"><span>üéØ</span> Recentrar vista</button>
      <a class="btn" id="btnRef" href="#"><span>üîß</span> Solicitar refacci√≥n</a>
      <a class="btn" id="btnChat" href="#"><span>üí¨</span> Chat B√≥veda IA</a>
      <a class="btn" id="btnTeamsClient" href="#"><span>Óúµ</span> Abrir en Teams (cliente)</a>
      <a class="btn" id="btnTeamsWeb" href="#"><span>üåê</span> Abrir en Teams (web)</a>
    </div>
  </header>

  <div id="main">
    <div id="viewerCard">
      <div id="drop">Suelta aqu√≠ un archivo .glb para visualizar</div>
      <!-- lienzo Three.js -->
    </div>

    <aside id="sideCard">
      <div class="section">
        <h3>Informaci√≥n</h3>
        <div class="infoGrid">
          <div class="label">Archivo</div><div id="infoArchivo">‚Äî</div>
          <div class="label">Parte</div><div id="infoParte">‚Äî</div>
          <div class="label">Subensamble</div><div id="infoSub">‚Äî</div>
          <div class="label">Ubicaci√≥n</div><div id="infoUbicacion">‚Äî</div>
        </div>
      </div>
      <div class="section">
        <h3>Estado</h3>
        <div id="status">Cargando modelo‚Ä¶</div>
        <div id="progress">0% 0 / 0 KB</div>
        <div id="error"></div>
      </div>
      <div class="section">
        <h3>Documentaci√≥n</h3>
        <div>PDF din√°mico por subensamble <a id="linkPDF" href="#">(abrir PDF)</a></div>
      </div>
    </aside>
  </div>

  <div class="footer">Listo.</div>

  <!-- C√≥digo ES Modules -->
  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/DRACOLoader.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';

    // GLB por defecto en la MISMA carpeta de GitHub Pages
    const DEFAULT_MODEL_URL = './assem2.glb';

    let scene, camera, renderer, controls, gltf, root;
    const viewerCard = document.getElementById('viewerCard');
    const statusEl = document.getElementById('status');
    const progressEl = document.getElementById('progress');
    const infoArchivoEl = document.getElementById('infoArchivo');
    const dropEl = document.getElementById('drop');
    const errorEl = document.getElementById('error');

    init();
    loadModel(DEFAULT_MODEL_URL, 'assem2.glb');

    function init(){
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0f1f2f);

      const rect = viewerCard.getBoundingClientRect();
      camera = new THREE.PerspectiveCamera(60, rect.width / rect.height, 0.1, 1000);
      camera.position.set(2.5, 2.0, 3.5);

      renderer = new THREE.WebGLRenderer({ antialias:true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(rect.width, rect.height);
      viewerCard.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      const hemi = new THREE.HemisphereLight(0xffffff, 0x334455, 0.9);
      hemi.position.set(0, 2, 0);
      scene.add(hemi);

      const dir = new THREE.DirectionalLight(0xffffff, 0.9);
      dir.position.set(5,5,5);
      scene.add(dir);

      const grid = new THREE.GridHelper(10, 20, 0x3a6fb0, 0x234b77);
      grid.position.y = -0.001;
      scene.add(grid);

      window.addEventListener('resize', onResize);
      animate();

      document.getElementById('btnFit').addEventListener('click', fitView);
      const fileInput = document.getElementById('fileInput');
      fileInput.addEventListener('change', (e)=>{
        const f = e.target.files[0];
        if(!f) return;
        const url = URL.createObjectURL(f);
        infoArchivoEl.textContent = f.name;
        loadModel(url, f.name);
      });

      // Drag & drop
      ['dragenter','dragover'].forEach(evt=>{
        document.addEventListener(evt, (e)=>{ e.preventDefault(); dropEl.style.display='flex'; });
      });
      ['dragleave','drop'].forEach(evt=>{
        document.addEventListener(evt, (e)=>{ e.preventDefault(); dropEl.style.display='none'; });
      });
      document.addEventListener('drop', (e)=>{
        const f = e.dataTransfer.files[0];
        if(!f) return;
        const url = URL.createObjectURL(f);
        infoArchivoEl.textContent = f.name;
        loadModel(url, f.name);
      });
    }

    function loadModel(url, name){
      statusEl.textContent = 'Cargando modelo‚Ä¶';
      progressEl.textContent = '0% 0 / 0 KB';
      infoArchivoEl.textContent = name || url;
      errorEl.textContent = '';

      if(root){ scene.remove(root); disposeHierarchy(root); root = null; }

      const loader = new GLTFLoader();
      const dracoLoader = new DRACOLoader();
      // Decoders DRACO desde gstatic (CORS OK)
      dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');
      dracoLoader.setDecoderConfig({ type: 'wasm' });
      loader.setDRACOLoader(dracoLoader);

      loader.load(url, (g)=>{
        gltf = g; root = gltf.scene;
        scene.add(root);
        fitView();
        statusEl.textContent = 'Modelo cargado';
        progressEl.textContent = '';
      }, (xhr)=>{
        if(xhr.total){
          const pct = Math.round((xhr.loaded/xhr.total)*100);
          const kbLoaded = Math.round(xhr.loaded/1024);
          const kbTotal = Math.round(xhr.total/1024);
          progressEl.textContent = `${pct}% ${kbLoaded} / ${kbTotal} KB`;
          statusEl.textContent = `Cargando‚Ä¶ ${pct}%`;
        } else {
          statusEl.textContent = 'Descargando‚Ä¶';
        }
      }, (err)=>{
        console.error(err);
        errorEl.textContent = 'Error al cargar el modelo: ' + (err && err.message ? err.message : String(err));
        statusEl.textContent = 'Error al cargar el modelo';
      });
    }

    function fitView(){
      if(!root){ return; }
      const box = new THREE.Box3().setFromObject(root);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());

      root.position.x += (root.position.x - center.x);
      root.position.y += (root.position.y - center.y);
      root.position.z += (root.position.z - center.z);

      controls.target.copy(center);

      const maxDim = Math.max(size.x, size.y, size.z);
      const fitDist = (maxDim / (2 * Math.tan((Math.PI * camera.fov) / 360)));
      const offset = 1.25; // margen
      const newZ = center.z + fitDist * offset;
      camera.position.set(center.x + fitDist*0.6, center.y + fitDist*0.5, newZ);
      controls.update();
    }

    function disposeHierarchy(obj){
      obj.traverse(o=>{
        if(o.geometry) o.geometry.dispose();
        if(o.material){
          if(Array.isArray(o.material)) o.material.forEach(m=>m.dispose()); else o.material.dispose();
        }
      });
    }

    function onResize(){
      const rect = viewerCard.getBoundingClientRect();
      camera.aspect = rect.width / rect.height;
      camera.updateProjectionMatrix();
      renderer.setSize(rect.width, rect.height);
    }

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
