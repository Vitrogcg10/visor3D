
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Visor 3D de Proyectos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- model-viewer (GLB) -->
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 6px; }
    .muted { color: #666; font-size: 14px; }
    .grid { display: grid; gap: 16px; max-width: 1100px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .card { padding: 12px 14px; border: 1px solid #ddd; border-radius: 10px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 8px; background: #0a66ff; color: #fff; border: 0; cursor: pointer; text-decoration: none; }
    .btn.sec { background: #f5f5f5; color: #333; border: 1px solid #ddd; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    model-viewer { width: 100%; height: 560px; background: #f8f9fb; border-radius: 12px; border: 1px solid #e5e7eb; }
    ul { margin: 0; padding-left: 20px; }
    .error { color: #b00020; }
    code { background: #f3f3f3; padding: 0 4px; border-radius: 4px; }
    @media (max-width: 768px) {
      model-viewer { height: 420px; }
    }
  </style>
</head>
<body>
  <h1>Visor 3D de Proyectos</h1>
  <div class="muted" id="meta">Cargando‚Ä¶</div>

  <div class="grid">
    <div class="card">
      <model-viewer id="mv"
        src=""
        alt="Modelo 3D del proyecto"
        camera-controls
        touch-action="pan-y"
        shadow-intensity="0.6"
        ar
        ar-modes="webxr scene-viewer quick-look"
        exposure="1">
      </model-viewer>
    </div>

    <div class="row">
      <a id="btnDocs" class="btn" href="#" target="_blank" rel="noopener noreferrer">üìÑ Abrir documentaci√≥n</a>
      <a id="btnDescargarGLB" class="btn sec" href="#" target="_blank" rel="noopener noreferrer">‚¨áÔ∏è Descargar GLB</a>
      <span id="status" class="muted"></span>
    </div>

    <div id="listaPDFs" class="card" style="display:none;">
      <strong>PDFs del proyecto</strong>
      <ul id="ulPDFs"></ul>
    </div>

    <div id="errors" class="error"></div>

    <div class="muted">
      <strong>C√≥mo usar:</strong> abre con <code>?fileId=ID</code>.  
      Opcional: <code>&index=https://.../proyectos.json</code> para indicar otra ubicaci√≥n del √≠ndice.
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const fileId = Number(qs.get('fileId'));
    const indexUrl = qs.get('index') || 'https://raw.githubusercontent.com/tu-org/tu-repo/main/proyectos.json'; // <-- cambia a tu JSON

    const metaEl = document.getElementById('meta');
    const mv = document.getElementById('mv');
    const btnDocs = document.getElementById('btnDocs');
    const btnDescargar = document.getElementById('btnDescargarGLB');
    const errorsEl = document.getElementById('errors');
    const statusEl = document.getElementById('status');
    const listaPDFs = document.getElementById('listaPDFs');
    const ulPDFs = document.getElementById('ulPDFs');

    function esc(s) { return String(s ?? '').replace(/[<>&"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c])); }

    async function main() {
      if (!fileId) {
        errorsEl.textContent = "Falta el par√°metro obligatorio ?fileId=...";
        return;
      }

      try {
        statusEl.textContent = "Leyendo √≠ndice‚Ä¶";
        const res = await fetch(indexUrl, { mode: 'cors' });
        if (!res.ok) throw new Error(`No se pudo leer el √≠ndice (${res.status})`);
        const data = await res.json();

        const item = Array.isArray(data) ? data.find(x => Number(x.id) === fileId)
                   : (Array.isArray(data.items) ? data.items.find(x => Number(x.id) === fileId) : null);

        if (!item) {
          errorsEl.textContent = `No encontr√© el ID ${fileId} en el √≠ndice.`;
          return;
        }

        // Metadata
        metaEl.innerHTML = `
          <span class="muted">ID:</span> <strong>${esc(item.id)}</strong> ¬∑
          <span class="muted">Pa√≠s:</span> ${esc(item.pais || '-') } ¬∑
          <span class="muted">Planta:</span> ${esc(item.planta || '-') } ¬∑
          <span class="muted">Proyecto:</span> ${esc(item.proyecto || '-') } ¬∑
          <span class="muted">Disciplina:</span> ${esc(item.disciplina || '-') }
        `;

        // GLB
        if (!item.glbUrl) {
          errorsEl.textContent = "No hay glbUrl en el √≠ndice para este ID.";
          return;
        }

        // Importante: usa la URL RAW si el archivo est√° en GitHub
        mv.src = item.glbUrl;
        btnDescargar.href = item.glbUrl;

        // Documentaci√≥n
        if (item.docsUrl) {
          btnDocs.href = item.docsUrl;
          btnDocs.removeAttribute('disabled');
        } else {
          btnDocs.setAttribute('disabled', 'true');
        }

        // Lista de PDFs (opcional)
        if (Array.isArray(item.docs) && item.docs.length) {
          ulPDFs.innerHTML = '';
          for (const d of item.docs) {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = d.url;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.textContent = d.name || d.url;
            li.appendChild(a);
            ulPDFs.appendChild(li);
          }
          listaPDFs.style.display = 'block';
        } else {
          listaPDFs.style.display = 'none';
        }

        statusEl.textContent = "Listo.";
      } catch (err) {
        console.error(err);
        errorsEl.textContent = `Error: ${err.message || err}`;
      }
    }

    main();
  </script>
</body>
</html>
